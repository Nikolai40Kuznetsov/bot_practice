import telebot
from telebot import types
from id import name
import requests
import pandas as pd
import random

TOKEN = name
bot = telebot.TeleBot(TOKEN)

def tell_weather(message):
    url = f"https://wttr.in/Minsk?format=j1"
    r = requests.get(url).json()
    forecast = {"Date": [], "Temp": [], "Weather": []}
    df = pd.DataFrame(forecast)
    for day in r["weather"]:
        date = day["date"]
        avgtemp = day["avgtempC"]
        desc = day["hourly"][4]["weatherDesc"][0]["value"]
        df.loc[len(df)] = [date, f"{avgtemp}*C", desc]
        bot.send_message(message, df)

def get_random_country():
    response = f"https://restcountries.com/v3.1/all"
    countries = requests.get(response).json()     
    country = random.choice(countries)        
    result = "–°–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞:\n\n"
    result += f"üá∫üá≥ {country.get('name', {}).get('common', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
    result += f"–°—Ç–æ–ª–∏—Ü–∞: {', '.join(country.get('capital', ['–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ']))}\n"
    result += f"–ù–∞—Å–µ–ª–µ–Ω–∏–µ: {country.get('population', 0):,}\n"
    result += f"–ü–ª–æ—â–∞–¥—å: {country.get('area', 0):,} –∫–º¬≤\n"
    result += f"–†–µ–≥–∏–æ–Ω: {country.get('region', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
    if country.get('languages'):
        languages = list(country['languages'].values())
        result += f"–Ø–∑—ã–∫–∏: {', '.join(languages[:3])}\n"
    return result

@bot.message_handler(Commands = ["start"])
def send_welcome(message):
    keyboard_markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    info = types.KeyboardButton("–ò–Ω—Ñ–æ")
    video = types.KeyboardButton("–í–∏–¥–µ–æ")
    weather = types.KeyboardButton("–ü–æ–≥–æ–¥–∞")
    country = types.KeyboardButton("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª—É—á–∞–π–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ")
    keyboard_markup.add(info, video, weather)
    keyboard_markup.add(country)
    bot.send_message(message, "–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ—Å—Ç–æ–π –±–æ—Ç –Ω–∞ telebot")

@bot.message_handler(func=lambda message:True)
def echo_all(message):
    if message.text == "–ò–Ω—Ñ–æ":
        bot.send_message(message, f"–¢—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É '–ò–Ω—Ñ–æ'")
    elif message.text == "–ü–æ–≥–æ–¥–∞":
        tell_weather()
    elif message.text == "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª—É—á–∞–π–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ":
        get_random_country()
        # bot.send_sticker(message, ':love:')
    else:
        bot.send_message(message, f"–¢—ã –Ω–∞–ø–∏—Å–∞–ª {message.text}")
        
@bot.message_handler(func=lambda message:True)
def send_video(message):
    if message.text == "–í–∏–¥–µ–æ":
        bot.send_message(message, "@vid https://www.youtube.com/watch?v=m9wkjtT-j6o&pp=ygUJcmFpbmJsb29k")

def main():
    try:
        print("–ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è")
        bot.polling(none_stop=True)        
    except:
        print("–ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è")
        
if __name__ == "__main__":
    main()